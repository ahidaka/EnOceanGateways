<!DOCTYPE html>
<html>
<head>
<title>ローカルグラフ表示</title>

<link rel="stylesheet" type="text/css" href="dist/css/tests.css">
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
<script src="dist/js/epoch.js"></script>
<script src="dist/js/data.js"></script>
<link rel="stylesheet" type="text/css" href="dist/css/epoch.css">

<script>
    var nextTime = (function() {
        var currentTime = parseInt(new Date().getTime() / 1000);
        return function() { return currentTime++; }
    })();
</script>

<style>
    .gauges {
        display: inline-block;
        margin: 1em;
    }
</style>

</head>
<body>
    
<h1>ローカルグラフ表示</h1>

<!-- TP HU IL Gauge -->
<div id="gauge-tp" class="gauges">
    <h2>TP 温度センサー</h2>
    <div class="epoch gauge-small"></div>
</div>
<div id="gauge-hu" class="gauges">
    <h2>HU 湿度センサー</h2>
    <div class="epoch gauge-small"></div>
</div>
<div id="gauge-il" class="gauges">
    <h2>IL 照度センサー</h2>
    <div class="epoch gauge-small"></div>
</div>
<script>
    //
    var message = new GaugeData();

    var values = {};
    var units = {};

    //
    // Gauge display
    //
    $(function() {
        var datas = {
            TP: 0.0,
            HU: 0.0,
            IL: 0,
        };

        var props = {
            TP: { type: 'time.gauge', value: 0, format: function(v) { return Math.abs((v*100).toFixed(1)) + "℃"; } },
            HU: { type: 'time.gauge', value: 0, format: function(v) { return Math.abs((v*100).toFixed(1)) + "%"; } },
            IL: { type: 'time.gauge', value: 0, format: function(v) { return Math.abs((v*1000).toFixed(0)) + "lx"; } },
        };

        var gauges = {
            TP: $('#gauge-tp .epoch').epoch(props["TP"]),
            HU: $('#gauge-hu .epoch').epoch(props["HU"]),
            IL: $('#gauge-il .epoch').epoch(props["IL"]),
        };

        function updateGauge() {
            for (var point in datas) {
                gauges[point].update(Math.abs(datas[point]));
            }
        }

        datas["TP"] = values["TP"] * 0.01;
        datas["HU"] = valurs["HU"] * 0.01;
        datas["IL"] = values["IL"] * 0.001;

        setInterval(updateGauge, 1000);
    });
</script>

<!-- AS CO display -->
<div>
    <h2>AS 加速度状態 CO 開閉状態</h2>
    <p>
        <font size="14" color="blue">AS:通常</font>
        &nbsp;&nbsp;&nbsp;&nbsp;
        <font size="14" color="blue">CO:開</font>
    </p>
</div>

<!-- TP HU IL CO line -->
<div id="tphuilco-line" class="test">
    <h2>TP 温度, HU 湿度, IL 照度, CO 開閉</h2>
    <div class="epoch"></div>
</div>

<script>
    $(function() {
        var data = [
            {
            label: 'TP',
            values: [],
            range: [0, 100]
            },
            {
            label: 'HU',
            values: [],
            range: [0, 100]
            },
            {
            label: 'IL',
            values: [],
            range: [0, 1000]
            },
            {
            label: 'CO',
            values: [],
            range: [-1, 2]
            }
        ];

        $('#tphuilco-line .epoch').epoch({
            type: 'time.line',
            axes: ['left', 'right', 'bottom'],
            data: data,
            range: {
                right: [-1, 2],
                left: [0, 100]
            }
        });

        function updateGraph() {
            var length = 50; //////////////////////
            for (var i = 0; i < length; i++) {
                var tp = values["TP"];
                var hu = values["HU"];
                var il = values["IL"];
                var co = values["CO"];
                var time = nextTime();
                data[0].values.push({time: time, y: tp});
                data[1].values.push({time: time, y: hu});
                data[2].values.push({time: time, y: il});
                data[3].values.push({time: time, y: co});
            }
        }
        setInterval(updateGraph, 1000);
    });
</script>

<!-- AX AY AZ AS line -->
<div id="accel-line" class="test">
    <h2>AX AY AZ 加速度, AS 状態</h2>
    <p>
    </p>
    <div class="epoch"></div>
</div>

<script>
    $(function() {
        var data = [
            {
            label: 'AX',
            values: [],
            range: [-3, 3]
            },
            {
            label: 'AY',
            values: [],
            range: [-3, 3]
            },
            {
            label: 'AZ',
            values: [],
            range: [-3, 3]
            },
            {
            label: 'AS',
            values: [],
            range: [0, 4]
            }
        ];

        $('#accel-line .epoch').epoch({
            type: 'time.line',
            axes: ['left', 'right', 'bottom'],
            data: data,
            range: {
                right: [-1, 3],
                left: [-3, 3]
            }
        });

        function updateGraph() {
            var length = 50;
            for (var i = 0; i < length; i++) {
                var ax = values["AX"];
                var ay = values["AY"];
                var az = values["AZ"];
                var as = values["AS"];
                var time = nextTime();
                data[0].values.push({time: time, y: ax});
                data[1].values.push({time: time, y: ay});
                data[2].values.push({time: time, y: az});
                data[3].values.push({time: time, y: as});
            }
        }
        setInterval(updateGraph, 1000);
    });
</script>

<script>
    $(() => {
        const socket = io();
        //socket.on('message', (msg) => {
        socket.on("message", function (d) {

            //$('#messages').append($('<li>').text(msg));
            //var s = d.toString();
            // Clear non printable character and omit error
            //s = s.replace(/\\n/g, "\\n")
            //    .replace(/\\'/g, "\\'")
            //    .replace(/\\"/g, '\\"')
            //    .replace(/\\&/g, "\\&")
            //    .replace(/\\r/g, "\\r")
            //    .replace(/\\t/g, "\\t")
            //    .replace(/\\b/g, "\\b")
            //    .replace(/\\f/g, "\\f");
            //s = s.replace(/[\u0000-\u0019]+/g,"");
            
            var obj = JSON.parse(d);

            var dataTelegram = obj.dataTelegram;
            var deviceId = dataTelegram.deviceId;
            var profile = dataTelegram.profile;
            var dataArray = dataTelegram.functions;
            dataArray.forEach(function(dataNode) {
            //console.log(" ",
            //  "key=" + dataNode.key,
            //  "value=" + dataNode.value,
            //  "unit=" + dataNode.unit);

                values[dataNode.key] = dataNode.value;
                units[dataNode.key] = dataNode.unit;
            });

        });
    });
  </script>

</body>
</html>
